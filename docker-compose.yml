version: '3.8'

services:
  # --- 1. Servicio Keycloak (Autenticación) ---
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.3
    container_name: keycloak
    command: start-dev
    ports:
      - "8081:8080" # Keycloak expuesto en el puerto 8081 de tu PC
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin123
    volumes:
      - keycloak_data:/opt/keycloak/data
    networks:
      - backend

  # --- 2. Base de Datos de Solicitudes ---
  db-solicitudes:
    image: postgres:latest
    container_name: db-solicitudes
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: DB_SOLICITUDES
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
    volumes:
      - data-solicitudes:/var/lib/postgresql 
      - ./db-scripts/solicitudes:/docker-entrypoint-initdb.d #
    networks:
      - backend

  # --- 3. Base de Datos de Rutas ---
  db-rutas:
    image: postgres:latest
    container_name: db-rutas
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: DB_RUTAS
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
    volumes:
      - data-rutas:/var/lib/postgresql 
      - ./db-scripts/rutas:/docker-entrypoint-initdb.d #
    networks:
      - backend

  # --- 4. Base de Datos de Usuarios ---
  db-users:
    image: postgres:latest
    container_name: db-users
    ports:
      - "5434:5432"
    environment:
      POSTGRES_DB: DB_USERS
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
    volumes:
      - data-users:/var/lib/postgresql 
      - ./db-scripts/usuarios:/docker-entrypoint-initdb.d #
    networks:
      - backend

  # --- 5. Microservicio App Rutas (NUEVO) ---
  rutas-app:
    build: ./rutas  # 1. Apunta a la carpeta 'rutas' que contiene el Dockerfile
    container_name: rutas-app
    ports:
      - "8181:8181" # 2. Mapea el puerto 8181 de tu PC al 8181 del contenedor
    environment:
      # --- Conexión a la Base de Datos 'db-rutas' ---
      SPRING_DATASOURCE_URL: jdbc:postgresql://db-rutas:5432/DB_RUTAS
      SPRING_DATASOURCE_USERNAME: admin
      SPRING_DATASOURCE_PASSWORD: admin123
      
      # --- Conexión a Keycloak (para Spring Security) ---
      # 3. URL para validar tokens. ¡Asegúrate que 'tpi-backend' es tu realm!
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/tpi-backend
    networks:
      - backend
    depends_on:
      - db-rutas    # Se asegura que la BD de rutas inicie primero
      - keycloak    # Se asegura que Keycloak inicie primero

  # --- 6. Microservicio Users ---
  users:
    build: ./users
    container_name: users-app
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://db-users:5432/DB_USERS
      SPRING_DATASOURCE_USERNAME: admin
      SPRING_DATASOURCE_PASSWORD: admin123
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/tpi-backend
    networks:
      - backend
    depends_on:
      - db-users
      - keycloak

# --- Volúmenes (Discos duros) ---
volumes:
  keycloak_data:
  data-solicitudes:
  data-rutas:
  data-users:

# --- Red interna ---
networks:
  backend:
    driver: bridge